<div id="module_wrapper" class="module_fillin">
  <div class="tabs">
    <span>任務一</span>
  </div>

  <div class="units-title wow bounceInRight"></div>

  <div class="sideTool">
    <div
      class="btn_discover"
      data-image=""
      data-text="二元搜尋樹是一種有根二元樹資料結構。它要求每個內部節點的鍵值都大於其左子樹中所有節點的鍵值，且都小於其右子樹中所有節點的鍵值。"
      data-video=""
      onClick="toggleAttachment($(this))"
    ></div>
  </div>

  <div id="contents" class="contents">
    <!--任務一-->
    <div>
      <div class="intro">
        <div>
          <h3>How to play?</h3>
          <p><b>文生圖</b>：根據維修廠新的規範，引導太空船進廠保養維修。</p>
          <img src="./DATA/PT4/BOOK1/IMAGES/PT4-1-4-4-intro.png" />
          <span class="cta" onClick="switchIntro()">START</span>
        </div>
      </div>
      <div class="subject wow fadeIn" style="width: 260px">
        <div class="sensorArea">
          <span
            onclick="parkHere($(this), event)"
            opt="num"
            class="sensor"
            style="width: 21px; height: 21px; top: 113px; left: 119px"
            ans="10"
          />
          <span
            onclick="parkHere($(this), event)"
            opt="num"
            class="sensor"
            style="width: 21px; height: 21px; top: 157px; left: 52px"
            parentIndex="0"
            ans="5"
          />
          <span
            onclick="parkHere($(this), event)"
            opt="num"
            class="sensor"
            style="width: 21px; height: 21px; top: 157px; left: 186px"
            parentIndex="0"
            ans="15"
          />
          <span
            onclick="parkHere($(this), event)"
            opt="num"
            class="sensor"
            style="width: 21px; height: 21px; top: 203px; left: 18px"
            parentIndex="1"
            ans="3"
          />
          <span
            onclick="parkHere($(this), event)"
            opt="num"
            class="sensor"
            style="width: 21px; height: 21px; top: 203px; left: 86px"
            parentIndex="1"
            ans="7"
          />
          <span
            onclick="parkHere($(this), event)"
            opt="num"
            class="sensor"
            style="width: 21px; height: 21px; top: 203px; left: 153px"
            parentIndex="2"
            ans="12"
          />
          <span
            onclick="parkHere($(this), event)"
            opt="num"
            class="sensor"
            style="width: 21px; height: 21px; top: 203px; left: 220px"
            parentIndex="2"
            ans="20"
          />
          <span
            onclick="parkHere($(this), event)"
            opt="num"
            class="sensor"
            style="width: 21px; height: 21px; top: 248px; left: 2px"
            parentIndex="3"
            ans="1"
          />
          <span
            onclick="parkHere($(this), event)"
            opt="num"
            class="sensor"
            style="width: 21px; height: 21px; top: 248px; left: 35px"
            parentIndex="3"
            ans="4"
          />
          <span
            onclick="parkHere($(this), event)"
            opt="num"
            class="sensor"
            style="width: 21px; height: 21px; top: 248px; left: 69px"
            parentIndex="4"
            ans="6"
          />
          <span
            onclick="parkHere($(this), event)"
            opt="num"
            class="sensor"
            style="width: 21px; height: 21px; top: 248px; left: 103px"
            parentIndex="4"
            ans="9"
          />

          <span
            onclick="parkHere($(this), event)"
            opt="num"
            class="sensor"
            style="width: 21px; height: 21px; top: 248px; left: 136px"
            parentIndex="5"
            ans="11"
          />
          <span
            onclick="parkHere($(this), event)"
            opt="num"
            class="sensor"
            style="width: 21px; height: 21px; top: 248px; left: 170px"
            parentIndex="5"
            ans="14"
          />
          <span
            onclick="parkHere($(this), event)"
            opt="num"
            class="sensor"
            style="width: 21px; height: 21px; top: 248px; left: 203px"
            parentIndex="6"
            ans="18"
          />
          <span
            onclick="parkHere($(this), event)"
            opt="num"
            class="sensor"
            style="width: 21px; height: 21px; top: 248px; left: 237px"
            parentIndex="6"
            ans="22"
          />
        </div>

        <div class="flights">
          <span
            data-num="10"
            style="top: 60px; left: 14px; transform: rotate(270deg)"
          ></span>
          <span
            data-num="15"
            style="top: 60px; left: 64px; transform: rotate(270deg)"
          ></span>
          <span
            data-num="5"
            style="top: 60px; left: 114px; transform: rotate(270deg)"
          ></span>
          <span
            data-num="20"
            style="top: 60px; left: 164px; transform: rotate(270deg)"
          ></span>
          <span
            data-num="12"
            style="top: 55px; left: 210px; transform: rotate(180deg)"
          ></span>
          <span
            data-num="3"
            style="top: 5x; left: 210px; transform: rotate(180deg)"
          ></span>
          <span
            data-num="1"
            style="top: -3px; left: 164px; transform: rotate(90deg)"
          ></span>
          <span
            data-num="18"
            style="top: -3px; left: 114px; transform: rotate(90deg)"
          ></span>
          <span
            data-num="22"
            style="top: -3px; left: 64px; transform: rotate(90deg)"
          ></span>
          <span
            data-num="7"
            style="top: -3px; left: 14px; transform: rotate(90deg)"
          ></span>
        </div>

        <!-- subjects -->
        <img
          style="width: 100%; height: auto"
          src="./DATA/PT4/BOOK1/IMAGES/PT4-1-4-4-1.png"
        />
      </div>

      <div class="options num">
        <div class="option" fillin="7">
          <span class="fillin">7</span>
        </div>
        <div class="option" fillin="22">
          <span class="fillin">22</span>
        </div>
        <div class="option" fillin="18">
          <span class="fillin">18</span>
        </div>
        <div class="option" fillin="1">
          <span class="fillin">1</span>
        </div>
        <div class="option" fillin="3">
          <span class="fillin">3</span>
        </div>
        <div class="option" fillin="12">
          <span class="fillin">12</span>
        </div>
        <div class="option" fillin="20">
          <span class="fillin">20</span>
        </div>
        <div class="option" fillin="5">
          <span class="fillin">5</span>
        </div>
        <div class="option" fillin="15">
          <span class="fillin">15</span>
        </div>
        <div class="option" fillin="10">
          <span class="fillin">10</span>
        </div>
        <div class="option" fillin="4">
          <span class="fillin">4</span>
        </div>
        <div class="option" fillin="11">
          <span class="fillin">11</span>
        </div>
        <div class="option" fillin="9">
          <span class="fillin">9</span>
        </div>
        <div class="option" fillin="14">
          <span class="fillin">14</span>
        </div>
        <div class="option" fillin="6">
          <span class="fillin">6</span>
        </div>
      </div>
    </div>
  </div>

  <div class="assetsPreload"></div>
</div>

<script>
  var setupPractice1 = function () {
    //修理站復原
    if ($(`#module_wrapper .sensorArea > .sensor[ans="14^11"]`).length > 0) {
      $(`#module_wrapper .sensorArea > .sensor[ans="14^11"]`)
        .attr("ans", "12")
        .html("12");
    }

    //
    if ($("#module_wrapper .flights > span").length == 10) {
      $("#module_wrapper .flights").append(`
          <span
            data-num="4"
            style="top: 60px; left: 14px; transform: rotate(270deg)"
          ></span>
          <span
            data-num="11"
            style="top: 60px; left: 64px; transform: rotate(270deg)"
          ></span>
          <span
            data-num="9"
            style="top: 60px; left: 114px; transform: rotate(270deg)"
          ></span>
          <span
            data-num="14"
            style="top: 60px; left: 164px; transform: rotate(270deg)"
          ></span>
          <span
            data-num="6"
            style="top: 55px; left: 210px; transform: rotate(180deg)"
          ></span>
    `);
    } else {
      $("#module_wrapper .flights > span[data-num='6']").removeClass(
        "selected"
      );
      $("#module_wrapper .flights > span[data-num='14']").removeClass(
        "selected"
      );
      $("#module_wrapper .flights > span[data-num='9']").removeClass(
        "selected"
      );
      $("#module_wrapper .flights > span[data-num='11']").removeClass(
        "selected"
      );
      $("#module_wrapper .flights > span[data-num='4']").removeClass(
        "selected"
      );
    }
    //把6,11,9,4,14修理站清空
    $(`#module_wrapper .sensorArea > .sensor[ans="6"]`)
      .removeAttr("fillin")
      .empty();
    $(`#module_wrapper .sensorArea > .sensor[ans="14"]`)
      .removeAttr("fillin")
      .empty();
    $(`#module_wrapper .sensorArea > .sensor[ans="9"]`)
      .removeAttr("fillin")
      .empty();
    $(`#module_wrapper .sensorArea > .sensor[ans="11"]`)
      .removeAttr("fillin")
      .empty();
    $(`#module_wrapper .sensorArea > .sensor[ans="4"]`)
      .removeAttr("fillin")
      .empty();
    //把12號太空船enabled
    $(`#module_wrapper .flights > span[data-num="12"]`).removeClass("disabled");
    //提示
    rootSoundEffect($correct);
    $(".alert").remove();
    var hinter = "又進來五台太空船了，請指引它們進場。";
    $("#contents > div.selected").append(
      `<div class="alert wow bounceInLeft" onClick="$(this).remove()">
          <p>${hinter}</p>
        </div>`
    );
  };

  var setupPractice3 = function () {
    //把12號太空船disabled
    $(`#module_wrapper .flights > span[data-num="12"]`).addClass("disabled");

    //把11,12,14修理站清空
    $(`#module_wrapper .sensorArea > .sensor[ans="11"]`)
      .removeAttr("fillin")
      .empty();
    $(`#module_wrapper .sensorArea > .sensor[ans="12"]`)
      .removeAttr("fillin")
      .empty();
    $(`#module_wrapper .sensorArea > .sensor[ans="14"]`)
      .removeAttr("fillin")
      .empty();
    //修理站替換

    $(`#module_wrapper .sensorArea > .sensor[ans="12"]`).attr("ans", "14^11");

    //把11,14號太空船復原
    $(`#module_wrapper .flights > span[data-num="11"]`).removeClass("selected");

    $(`#module_wrapper .flights > span[data-num="14"]`).removeClass("selected");
    //提示
    rootSoundEffect($correct);
    $(".alert").remove();
    var hinter =
      "12號太空船臨時有事離開了維修站，請問其他的太空船要怎麼移動才能保持原來的規則呢";
    $("#contents > div.selected").append(
      `<div class="alert wow bounceInLeft" onClick="$(this).remove()">
          <p>${hinter}</p>
        </div>`
    );
  };

  var doneFirstFlights = function (amount) {
    var totalFlights = $(
      "#module_wrapper .flights > span:not('.disabled')"
    ).length;
    var totalFlightsSelected = $(
      "#module_wrapper .flights > span.selected"
    ).length;
    if (totalFlights == totalFlightsSelected && totalFlights == amount) {
      return true;
    } else {
      return false;
    }
  };

  var parkHere = function (tar, e) {
    $(".alert").remove();
    var ansArr = tar.attr("ans").split("^");

    var flights = $(
      `#module_wrapper .flights > span:not(".selected"):not(".disabled")`
    );
    var correctFlights = flights.filter((index, item) => {
      var dataNum = $(item).attr("data-num");
      return ansArr.indexOf(dataNum) !== -1;
    });
    var isCorrectFlight = flights.eq(0).is(correctFlights);

    if (!isCorrectFlight) {
      rootSoundEffect($stupid);
      var hinter =
        "注意！節點的值必須都大於其左子樹中所有節點的值，且都小於其右子樹中所有節點的值。";

      if (flights.length == 0) {
        hinter = "沒有太空船在排隊喔。";
      }
      $("#contents > div.selected").append(
        `<div class="alert wow bounceInLeft" onClick="$(this).remove()">
          <p>${hinter}</p>
        </div>`
      );
      // 停止同一元素上其他 click handler（例如 fillin.js 綁的 click）
      if (e) {
        e.preventDefault();
        e.stopImmediatePropagation();
      }
      return false;
    } else {
      rootSoundEffect($correct);
      var opt = tar.attr("opt");
      var matchedDataNum = correctFlights.eq(0).attr("data-num");
      var options = $(
        `#module_wrapper #contents div.selected .options.${opt} .option[fillin="${matchedDataNum}"]`
      );

      flights.eq(0).addClass("selected");
      options.addClass("selected");
      options.siblings(".selected").removeClass("selected");
      //判斷是否開啟過$("#PT4-1-4-4-5").length > 0
      if ($("#PT4-1-4-4-5").length > 0) {
        //判斷做完了沒有
        var practiceID = $("#PT4-1-4-4-5")
          .find("#module_wrapper_keep .tabs_keep > span.selected")
          .index();
        var isDoneFirst10 = doneFirstFlights(10);

        if (isDoneFirst10) {
          setupPractice1();
        }

        var isDoneFirst15 = doneFirstFlights(15);
        if (isDoneFirst15 && practiceID == 2) {
          //do something
          setupPractice3();
        }
      }
    }
  };

  var specialProcess = function () {
    console.log("specialProcess");
    //如果目前處於#PT4-1-4-3-4且#PT4-1-4-4-5存在，執行下列程式碼
    if (
      $("#PT4-1-4-3-4").hasClass("selected") &&
      $("#PT4-1-4-4-5").length > 0
    ) {
      //
      var practiceID = $("#PT4-1-4-4-5")
        .find("#module_wrapper_keep .tabs_keep > span.selected")
        .index();
      console.warn(practiceID);
      if (practiceID == 0) {
        //判斷做完了沒有
        var isDoneFirst10 = doneFirstFlights(10);
        if (isDoneFirst10) {
          setupPractice1();
        }
        //若做超過練習1了，則執行練習1的設定
        if ($("#module_wrapper .flights > span").length > 10) {
          setupPractice1();
        }
      } else if (practiceID == 1) {
        //甚麼事情都不做
      } else if (practiceID == 2) {
        var isDoneFirst10 = doneFirstFlights(10);
        if (isDoneFirst10) {
          setupPractice1();
        }
        //15台都做好了
        var isDoneFirst15 = doneFirstFlights(15);
        if (isDoneFirst15) {
          setupPractice3();
        }
      }
    }
  };
</script>

<style>
  .sensorArea .sensor {
    pointer-events: none !important;
  }
  .sensorArea .sensor:empty {
    pointer-events: auto !important;
  }
  .flights {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
  }
  .flights > span {
    position: absolute;
    width: 45px;
    height: 45px;
    background-image: url("./DATA/PT4/BOOK1/IMAGES/flight.png");
    background-size: contain;
    transition: opacity 0.5s ease-in-out;
  }
  .flights > span.selected {
    opacity: 0;
  }

  .flights > span::before {
    content: attr(data-num);
    width: 16px;
    height: 16px;
    transform: translate(-50%, -35%);
    position: absolute;
    top: 50%;
    left: 50%;
    border: 1px solid #ea5e88;
    border-radius: 100%;
    background: #fff;
    display: grid;
    place-items: center;
    font-size: 10px;
    color: #ea5e88;
    line-height: 14px;
    font-weight: bold;
  }
</style>
