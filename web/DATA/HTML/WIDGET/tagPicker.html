<div class="tagpicker_wrapper wow slideInUp">
  <span class="edit active" mt="2"
    ><img src="./DATA/IMAGES/common/board_draw.png"
  /></span>
  <span class="eraseAll" mt="2"
    ><img src="./DATA/IMAGES/common/board_clear.png"
  /></span>
  <div class="drawer"><canvas width="197" height="108"></canvas></div>
  <div class="keyer">
    <textarea spellcheck="false" id="mytext"></textarea>
  </div>
</div>
<div class="assetsPreload">
  <img src="./DATA/IMAGES/common/board.png" />
  <img src="./DATA/IMAGES/common/board_draw.png" />
  <img src="./DATA/IMAGES/common/board_keyboard.png" />
  <img src="./DATA/IMAGES/common/board_clear.png" />
</div>

<script>
  $(document).ready(function () {
    //$("#keyboard").remove();
    //$("#mytext").keyboard();
    //
    $("#tagPicker")
      .unbind()
      .bind("mousedown", function (e) {
        getHighestDepthWidget($(this));
      })
      .bind("touchstart", function (e) {
        getHighestDepthWidget($(this));
      });
    getHighestDepthWidget($("#tagPicker"));

    $("#tagPicker .edit")
      .unbind()
      .bind("mousedown", function (e) {
        click.x = e.clientX;
        click.y = e.clientY;
      })
      .bind("mouseup", function (e) {
        if (
          Math.abs(click.x - e.clientX) < click.threshold * stageRatioReal &&
          Math.abs(click.y - e.clientY) < click.threshold * stageRatioReal
        ) {
          $(this).siblings(".drawer").show();
          $(this).siblings(".keyer").hide();
          $(this).addClass("active").siblings(".active").removeClass("active");
          //
          $("#mytext").val("");
        }
      });
    $("#tagPicker .keyboard")
      .unbind()
      .bind("mousedown", function (e) {
        click.x = e.clientX;
        click.y = e.clientY;
      })
      .bind("mouseup", function (e) {
        if (
          Math.abs(click.x - e.clientX) < click.threshold * stageRatioReal &&
          Math.abs(click.y - e.clientY) < click.threshold * stageRatioReal
        ) {
          $(this).siblings(".drawer").hide();
          $(this).siblings(".keyer").show();
          $(this).addClass("active").siblings(".active").removeClass("active");
          //
          var clearTar = $(this).siblings(".drawer").find("canvas");
          var cctx = clearTar.get(0).getContext("2d");
          cctx.clearRect(0, 0, clearTar.attr("width"), clearTar.attr("height"));
          $("input[name='username']").keyboard();
          $("#password").keyboard();
        }
      });
    $("#tagPicker .eraseAll")
      .unbind()
      .bind("mousedown", function (e) {
        click.x = e.clientX;
        click.y = e.clientY;
      })
      .bind("mouseup", function (e) {
        if (
          Math.abs(click.x - e.clientX) < click.threshold * stageRatioReal &&
          Math.abs(click.y - e.clientY) < click.threshold * stageRatioReal
        ) {
          var clearTar = $(this).siblings(".drawer").find("canvas");
          var cctx = clearTar.get(0).getContext("2d");
          cctx.clearRect(0, 0, clearTar.attr("width"), clearTar.attr("height"));
          //
          $("#mytext").val("");
        }
      });
    //
    var can = $("#tagPicker").find(".drawer > canvas").get(0);
    var ctx = can.getContext("2d");
    var isDraw = false;
    ctx.strokeStyle = "#66ccff";
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
    var startX, startY;
    var _eraserWidth = 100;
    var newZoomRatio = stageRatioReal / stageRatioMain;
    var ol = 8;
    var ot = 7;

    // Mouse Down Event
    ["mousedown", "touchstart"].forEach(function (e) {
      can.addEventListener(e, function (event) {
        isDraw = true;
        newZoomRatio = stageRatioReal / stageRatioMain;

        if (event.clientX) {
          startX =
            (event.clientX - $(".tagPicker").offset().left) / newZoomRatio - ol;
          startY =
            (event.clientY - $(".tagPicker").offset().top) / newZoomRatio - ot;
        } else {
          startX =
            (event.touches[0].clientX - $(".tagPicker").offset().left) /
              newZoomRatio -
            ol;
          startY =
            (event.touches[0].clientY - $(".tagPicker").offset().top) /
              newZoomRatio -
            ot;
        }
      });
    });

    // Mouse Move Event
    ["mousemove", "touchmove"].forEach(function (e) {
      can.addEventListener(e, function (event) {
        if (isDraw) {
          if (event.clientX) {
            drawLineBoard(
              startX,
              startY,
              (event.clientX - $(".tagPicker").offset().left) / newZoomRatio -
                ol,
              (event.clientY - $(".tagPicker").offset().top) / newZoomRatio -
                ot,
            );
          } else {
            drawLineBoard(
              startX,
              startY,
              (event.touches[0].clientX - $(".tagPicker").offset().left) /
                newZoomRatio -
                ol,
              (event.touches[0].clientY - $(".tagPicker").offset().top) /
                newZoomRatio -
                ot,
            );
          }
        }
      });
    });

    ["mouseup", "mouseleave", "touchend"].forEach(function (e) {
      can.addEventListener(e, function (event) {
        isDraw = false;
      });
    });

    function drawLineBoard(x, y, stopX, stopY) {
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(stopX, stopY);
      ctx.closePath();
      ctx.stroke();
      startX = stopX;
      startY = stopY;
    }
    //
    $("#tagPicker")
      .attr("id", "")
      .delay(80)
      .queue(function () {
        $(this).dequeue();
        //makeDraggable($(this), false, $(this));
      });
  });
</script>
